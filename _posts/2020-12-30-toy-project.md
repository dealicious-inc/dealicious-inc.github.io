---
layout: page
title: '[개발문화] 딜리셔스 개발팀의 toy project'
writer: 서혜리
thumbnail: 'posts/2020-12-30-toy-project-04.png'
---

# 1. 들어가기 전
 

안녕하세요. 딜리셔스의 주니어 백엔드 개발자 서혜리입니다.  
딜리셔스는 널리 알리고싶은 장점이 참 많은 회사인데요,  
그 중에 한가지는 바로 개발자들과 애증, 토이프로젝트 문화입니다.  
  
때는 바야흐로 2019년 12월  
딜리셔스 slack general 채널에 이런 메시지가 올라왔습니다.

![](/assets/image/posts/2020-12-30-toy-project-01.png)
*용화님이 보우하사 우리 개발팀 만세*

  
회사 차원에서 토이프로젝트에 대한 시간적, 리소스적 지원을 하겠다는 CTO님의 공표가 바로 그것이었습니다.  
이 역사적인 순간을 시작으로 저희는 합법적으로(!) 회사 안에서 토이프로젝트 개발을 할 수 있게 되었습니다. (두둥)

 

그 이후로 1년이 미처 안되는 시간이 흘렀고 그동안 다양한 토이프로젝트들이 진행이 되었는데요,  
오늘은 제가 백엔드 파트에 합류한지 5개월차에 진행했던 토이 프로젝트에 대해 소개하려고 합니다.

 

# 2. 사건의 발단

제가 속한 백엔드 파트에서는 매일 아침 데일리 스탠드업 미팅을 하는데요, 여기서 사용해보고싶은 기술이나, 서비스, 진행해보고싶은 프로젝트에 대한 아이디어를 내고 작게 팀을 꾸려 토이프로젝트를 실행하곤 합니다.  
당시에도 여러가지 아이디어들이 나왔고 그중에 하나가 이미지 중복에 관한 이슈였습니다.

 

![](/assets/image/posts/2020-12-30-toy-project-02.png)
*신상마켓 웹 화면*
 

딜리셔스의 메인 서비스인 신상마켓 앱에는 월 180만개 이상의 상품이 업로드 됩니다.(올해 10월 기준) 그리고 상품의 노출이 판매량에 직접적인 영향을 미치는만큼 중복 상품이 전체 상품에서 상당 수를 차지합니다.  
당시는 이미지 리사이징과 캐싱 시스템을 막 리뉴얼한 이후였는데요, 성공적으로 캐싱 시스템을 적용했지만 그 효율이 기대만큼 좋지않았습니다. 중복 상품, 그에 따른 중복 이미지가 많다보니 기껏 캐싱한 이미지를 다시 찾아 쓰는 비율이 높지 않았고 사실상 같은 이미지를 계속해서 캐싱하는 일이 발생했기 때문입니다.


이미지 캐싱 서버의 부하를 줄이고, 낭비되는 스토리지 사용량을 줄이기 위해서 저희는 이미지를 재활용 할 필요가 있었습니다. 


>"이거 엄청 쉬울 것 같은데 해보고싶으신 분?"  
>
>  "저요!"
 

 

그때 마침 저는 푸시 시스템 개발 프로젝트를 마치고 시간적으로 여유가 있던 상황이었고  
(사실 뭐든지 쉽다고 말씀하시는..) 파트장 형성님의 쉬울 것이라는 말씀에 혼자서 Hola 프로젝트를 시작하게 됐습니다.

 


![](/assets/image/posts/2020-12-30-toy-project-03.png)
*( 프로젝트명 뜻풀이 : 이미지를 올리니까 올라.. Hola... )*
 

 

# 3. 어떻게 해결했나
 

여러가지로 고민을 했지만 사실 접근방법 자체는 형성님이 말씀하신 것처럼 굉장히 간단했습니다.

![](/assets/image/posts/2020-12-30-toy-project-05.png)

중심이 되는 로직은 이게 다 였거든요.

그래서 가벼운 마음으로 작업을 시작하려고 보니
![](/assets/image/posts/2020-12-30-toy-project-04.png)
*알록달록 무지개 인덴테이션*
 

이렇게나 굉장한 복잡도의 친구가 저를 기다리고 있었습니다....  
그래서 저는 가벼운 마음으로 모듈화 부터 시작했습니다 하핫.

 

## < 기존 API >

![](/assets/image/posts/2020-12-30-toy-project-06.png)
일단 기존 api는 이렇게 요청이 들어온 모든 이미지를 s3에 저장하고 있었습니다.  
그리고 저장한 이미지의 주소를 상품 이미지 테이블에 저장을 했습니다.


이러한 시스템에서 새로운 이미지만 저장을 하기 위해서는 이미지의 중복 여부를 체크해야했는데요,  
이 또한 아주 간단하게 해결을 했습니다.

 

## < 바뀐 API >
 
![](/assets/image/posts/2020-12-30-toy-project-07.png)

저는 상품 이미지 table외에 상품 이미지의 hash를 저장하는 테이블을 신규로 생성했습니다.

그리고 이미지를 등록할때마다 s3에 바로 저장하는 게 아니라 이미지의 md5 hash를 구한 뒤,
image hash 테이블에 기존 hash가 있는지 확인하는 방식으로 중복을 체크했습니다.


그리고 hash가 존재하지 않는다면 이미지 업로드 후 url과 hash를 image hash 테이블에 저장했고, 동일한 데이터를 상품 이미지 테이블에도 저장해주었습니다.  

![](/assets/image/posts/2020-12-30-toy-project-08.png)

반대로 hash가 존재한다면 hash 테이블에 저장된 기존의 url을 가져와 상품 이미지 테이블에 저장해주었습니다.

 

 

그리고 도식에는 그리지는 않았지만 사실 기존 api에도 이미지의 중복 체크 로직이 존재했는데요,  
중복 체크를 php의 imagehash 라이브러리에 의존하고 있어 레거시 서버를 java나 rails로 이전하고 있는 백엔드 파트의 현재 상황과 잘 맞지 않았습니다. 때문에 언어나 플랫폼에 의존적이지않으면서 비교적 해싱 속도가 빠른 md5를 선택하게 되었습니다.

 

 

그리고 이미지 업로드와 중복에 대한 데이터를 쌓기 위해 **aws kinesis firehose**로 로그를 쌓아 주었습니다.  
이후에는 athena로 로그를 쿼리할 수 있도록 날짜와 시간을 기준으로 파티셔닝 해주었습니다. (데이터는 아래에서 설명하겠습니다.)


![](/assets/image/posts/2020-12-30-toy-project-09.png)


이렇게 글로 보니 설명하기 민망할 정도로 간단한 로직이었는데요.. 
간단하지만 기존의 비지니스 로직을 그대로 가져가면서 기능적로 훌륭하게 이미지의 중복을 체크하고 있습니다.


### 4. 결과는 어땠나
 

잘해보고 싶은 마음에 여러가지로 생각해보는 시간 외에 구현 자체에 드는 시간은 비교적 짧았던 프로젝트였는데요,  
결과적으로는 꽤나 성과가 있었습니다.

![](/assets/image/posts/2020-12-30-toy-project-10.png)

위 이미지는 프로젝트가 끝난 후에 사내에 공유했던 통계인데요,  
그래프를 보시면 배포 직후에는 이미지 중복 여부를 구분할 수 있는 내부의 데이터가 없기때문에 중복 이미지의 수가 새로운 이미지에 비해 훨씬 적습니다. 하지만 시간에 지남에 따라 중복 이미지 업로드 수가 증가세를 보이다가 3월 26일을 기준으로 새로운 이미지 업로드 수를 추월합니다. 업로드 수 뿐만 아니라 업로드 용량 또한 비슷한 추세를 보입니다. 

![](/assets/image/posts/2020-12-30-toy-project-11.png)

위 표는 지난주의 같은 데이터인데요, 이미지 hash 데이터가 충분히 쌓인 지금은 평균적으로 전체 대비 70퍼센트의 이미지가 중복되며 그만큼의 저장소 용량을 절약하고 있다는 것을 볼 수 있습니다.  
뿐만 아니라 그간 저희 회사에는 상품의 중복, 혹은 이미지의 중복에 대한 데이터가 전무했기 때문에 그 자체로 데이터 적인 의의가 있었습니다.

![](/assets/image/posts/2020-12-30-toy-project-12.png)

추가적으로 위 이미지는 이미지 캐싱, 리사이징 서버의 요청에 대한 통계인데요,  
hola 프로젝트를 릴리즈한 시점과 비슷하게 waf 요청 수 대비 리사이징 서버의 요청이 줄어드는 것을 볼 수가 있습니다.


사실 hola 릴리즈와 비슷한 기간에 캐시 데이터의 저장 시간을 늘리기도 해서 (그래프 안에 빨간선이 저장 시간을 늘린 시점입니다)  
이 데이터로 정확히 hola만의 결과를 볼 수는 없습니다.   
하지만 위의 이미지 중복 데이터로 캐싱 서버의 부하를 줄이는데 크게 도움을 줬을 것이라는 합리적인 추론을 해볼 수 있을 것 같습니다.
 

주니어 개발자로서 혼자서 프로젝트를 시작부터 끝까지 진행했다는 점,  
내 작업물로 회사에 가시적인 이익을 줬다는점,  
처음으로 php로 개발을 해봤다는 점,  
처음으로 aws firehose를 사용해 봤다는 점 등등 Hola는 저 스스로에게도 의의가 큰 프로젝트였습니다.


Hola는 누가 요청했던 일도, 기획자나 c레벨을 통해 프로젝트로 발의됐던 일도 아니었는데요,  
때문에 토이프로젝트로 백엔드 내부에서 시작하지 않았다면 쉽게 간과하고 넘어갈수 있었을 것입니다.  
회사에서 개발자들에게 어느정도의 자율권을 줬기 때문에 위와 같은 성과를 얻을 수 있지 않았나 생각을 해봅니다.

 

 

# 5. 기타 등등 프로젝트
 
위에서 얘기한 hola처럼 업무와 관련된 토이프로젝트 말고도 오로지 재미를 위한 프로젝트들도 많았습니다.  

![](/assets/image/posts/2020-12-30-toy-project-13.png)
*원격으로 카페테리아 노래를 틀 수 있는 강디너님, 혜지님의 딜리비트*
 
![](/assets/image/posts/2020-12-30-toy-project-14.jpeg)
*선진님의 천하제일탁구대회 선수소개 페이지*
 
![](/assets/image/posts/2020-12-30-toy-project-15.jpeg)
*선진님의 천하제일탁구대회 경기판*

![](/assets/image/posts/2020-12-30-toy-project-16.png)
*연말을 맞아 제작중인 딜리셔스 미궁게임*
 

# 6. 결론
용화님의 파격선언(!) 이후 1년정도의 시간이 흘렀는데요,  
결과적으로 봤을 때 토이프로젝트는 개인의 성장에도 회사의 발전에도 도움이 되었던 것 같습니다.

 

토이프로젝트 하면 좋다는 건 어떤 개발자든지 잘 알고 있죠.  
회사에서 시키는 일이 아니라 내가 쓰고 싶은 기술로 내가 하고싶은 개발을 할 수 있으니까요.  
하지만 직장인의 저녁이란.. 정말이지 찰나같기때문에 쉽사리 프로젝트를 시작하지 못한다는 것도 사실입니다.  
하지만 저희 회사처럼 회사 차원에서 지원을 해준다면 사실 하지않을 이유가 없다고 보는데요,

네... 결론은....


우리회사 짱짱맨이라는 것입니다...!  
이렇게 수미상관으로 포스팅을 마쳐보겠습니다. 그럼 안녕히...